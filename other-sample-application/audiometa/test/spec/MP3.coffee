"use strict"
describe "Factory: MP3", ->
	
	# load the controller's module
	beforeEach module "audiometa"

	# globals
	toHex = (hexArray) -> hexArray.map((hex)-> String.fromCharCode(parseInt(hex, 16))).join ""
	mp3Header = toHex [\
	"ff", "fb", "a0", "40", "00", "00", "02", "8b", "37", "52", "7d", "30", "40", "00", "55", "e7",\
	"8a", "4f", "a6", "08", "00", "08", "48", "29", "8d", "b8", "f5", "90", "11", "1e", "05", "32",\
	"b7", "1e", "f2", "42", "9d", "a7", "33", "42", "03", "12", "4a", "49", "8d", "c0", "38", "ee",\
	"39", "00", "02", "d0", "16", "25", "ab", "60", "cc", "cd", "fc", "58", "b2", "9d", "72", "11",\
	"a7", "79", "08", "73", "d3", "3b", "a1", "cf", "4c", "ef", "39", "ff", "9d", "fa", "9d", "e7",\
	"3b", "ff", "f5", "3b", "a1", "ce", "ff", "9f", "e7", "74", "03", "3c", "93", "81", "8b", "40",\
	"30", "31", "c3", "41", "f7", "ff", "fc", "31", "13", "83", "ff", "77", "e2", "77", "87", "f0",\
	"ff", "13", "bd", "b5", "83", "f3", "32", "ec", "ac", "42", "00", "9b", "69", "37", "68", "04",\
	"40", "09", "c0", "0c", "2b", "29", "08", "04", "ca", "92", "0f", "1c", "d6", "ce", "ef", "8b",\
	"00", "c0", "dc", "84", "6e", "73", "ff", "39", "e8", "de", "73", "ff", "3b", "ff", "39", "df",\
	"21", "3f", "a9", "dd", "0e", "77", "fa", "1c", "fd", "4e", "e4", "03", "03", "74", "25", "5d",\
	"0e", "79", "27", "0e", "74", "03", "16", "e4", "04", "e1", "f2", "75", "83", "ff", "d6", "0f",\
	"f2", "ef", "d6", "1f", "5e", "27", "3e", "1f", "ac", "1f", "e5", "e4", "7b", "6b", "f4", "20",\
	"24", "53", "2d", "94", "8a", "45", "a5", "2c", "d8", "83", "8e", "32", "7c", "4b", "49", "9b",\
	"89", "40", "23", "c3", "d6", "88", "25", "58", "39", "43", "0d", "9c", "87", "f1", "ba", "2d",\
	"06", "d3", "dc", "df", "47", "1b", "25", "5d", "35", "eb", "d0", "9a", "f5", "51", "3f", "9a",\
	"ba", "36", "bf", "9f", "f2", "89", "f7", "09", "7e", "9a", "3f", "34", "9e", "99", "35", "9e",\
	"5d", "89", "45", "33", "12", "64", "c4", "5a", "2d", "b9", "37", "2e", "69", "22", "f2", "79",\
	"06", "99", "39", "1d", "05", "bc", "8d", "c0", "08", "e9", "d0", "92", "2c", "0a", "d1", "94",\
	"a0", "23", "43", "78", "d4", "73", "95", "ec", "4d", "57", "46", "b2", "96", "bf", "2f", "a2"];

	id3v1 = toHex [ "54", "41", "47", "63", "61", "73", "73", "69",\
	"73", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "73", "74", "61", "6e", "64", "75", "70",\
	"37", "35", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "32", "30", "30", "33", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "47"]

	# Initialize the factory
	mp3Factory = undefined
	beforeEach inject ($injector) ->
		mp3Factory = $injector.get "MP3"

	it "checks if an hex strings starts with an MP3 header", ->
		isMP3 = mp3Factory._forUnitTests.isMP3
		expect(isMP3(id3v1)).toBe false
		expect(isMP3(mp3Header)).toBe true

	it "retrieves bitrate from an hexString", ->
		getBitRate = mp3Factory._forUnitTests.getBitRate
		# 1111 1111 1111 1011 1010 0000
		expect(getBitRate(toHex ["ff", "fb", "a0"])).toBe 160

