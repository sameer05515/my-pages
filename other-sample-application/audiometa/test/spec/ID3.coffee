"use strict"
describe "Factory: ID3", ->
	
	# load the controller's module
	beforeEach module "audiometa"

	# globals
	toHex = (hexArray) -> hexArray.map((hex)-> String.fromCharCode(parseInt(hex, 16))).join ""

	id3v1 = toHex [ "54", "41", "47", "63", "61", "73", "73", "69",\
	"73", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "73", "74", "61", "6e", "64", "75", "70",\
	"37", "35", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "32", "30", "30", "33", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "47"]

	id3v2 = toHex [\
	"49", "44", "33", "03", "00", "00", "00", "00", "13", "47", "55", "46", "49", "44", "00", "00",\
	"00", "5c", "00", "00", "68", "74", "74", "70", "3a", "2f", "2f", "77", "77", "77", "2e", "63",\
	"64", "64", "62", "2e", "63", "6f", "6d", "2f", "69", "64", "33", "2f", "74", "61", "67", "69",\
	"6e", "66", "6f", "31", "2e", "68", "74", "6d", "6c", "00", "33", "43", "44", "33", "4e", "39",\
	"30", "51", "31", "33", "33", "37", "38", "37", "37", "33", "33", "56", "37", "38", "43", "36",\
	"33", "37", "35", "45", "42", "31", "35", "33", "45", "43", "46", "38", "32", "42", "45", "32",\
	"45", "32", "42", "41", "37", "44", "45", "35", "36", "34", "42", "36", "39", "42", "50", "37",\
	"54", "58", "58", "58", "00", "00", "00", "14", "00", "00", "00", "52", "69", "70", "20", "64",\
	"61", "74", "65", "00", "32", "30", "30", "37", "2d", "30", "36", "2d", "30", "39", "54", "44",\
	"41", "54", "00", "00", "00", "05", "00", "00", "00", "31", "38", "30", "36", "54", "58", "58",\
	"58", "00", "00", "00", "0a", "00", "00", "00", "53", "6f", "75", "72", "63", "65", "00", "43",\
	"44", "54", "53", "53", "45", "00", "00", "00", "05", "00", "00", "00", "4c", "41", "4d", "45",\
	"54", "58", "58", "58", "00", "00", "00", "11", "00", "00", "00", "52", "69", "70", "70", "69",\
	"6e", "67", "20", "74", "6f", "6f", "6c", "00", "45", "41", "43", "54", "58", "58", "58", "00",\
	"00", "00", "15", "00", "00", "00", "52", "65", "6c", "65", "61", "73", "65", "20", "74", "79",\
	"70", "65", "00", "41", "64", "76", "61", "6e", "63", "65", "54", "49", "54", "32", "00", "00",\
	"00", "0d", "00", "00", "00", "31", "33", "39", "74", "68", "20", "53", "74", "72", "65", "65",\
	"74", "54", "59", "45", "52", "00", "00", "00", "05", "00", "00", "00", "32", "30", "30", "37",\
	"54", "4c", "41", "4e", "00", "00", "00", "04", "00", "00", "00", "65", "6e", "67", "54", "50",\
	"55", "42", "00", "00", "00", "16", "00", "00", "00", "56", "69", "64", "5a", "6f", "6e", "65",\
	"20", "44", "69", "67", "69", "74", "61", "6c", "20", "4d", "65", "64", "69", "61", "54", "43",\
	"4f", "4e", "00", "00", "00", "0b", "00", "00", "00", "44", "65", "65", "70", "20", "48", "6f",\
	"75", "73", "65", "54", "41", "4c", "42", "00", "00", "00", "10", "00", "00", "00", "45", "6c",\
	"65", "6d", "65", "6e", "74", "73", "20", "42", "65", "79", "6f", "6e", "64", "54", "50", "45",\
	"32", "00", "00", "00", "09", "00", "00", "00", "4f", "73", "75", "6e", "6c", "61", "64", "65",\
	"4d", "43", "44", "49", "00", "00", "00", "7e", "00", "00", "41", "00", "2b", "00", "39", "00",\
	"36", "00", "2b", "00", "39", "00", "44", "00", "45", "00", "46", "00", "2b", "00", "46", "00",\
	"41", "00", "43", "00", "41", "00", "2b", "00", "31", "00", "33", "00", "45", "00", "33", "00",\
	"41", "00", "2b", "00", "32", "00", "30", "00", "32", "00", "46", "00", "36", "00", "2b", "00",\
	"32", "00", "38", "00", "39", "00", "41", "00", "38", "00", "2b", "00", "32", "00", "45", "00",\
	"38", "00", "39", "00", "35", "00", "2b", "00", "33", "00", "36", "00", "36", "00", "44", "00",\
	"43", "00", "2b", "00", "33", "00", "44", "00", "37", "00", "46", "00", "31", "00", "2b", "00",\
	"34", "00", "34", "00", "42", "00", "32", "00", "35", "00", "2b", "00", "34", "00", "44", "00",\
	"38", "00", "35", "00", "33", "00", "00", "00", "54", "50", "4f", "53", "00", "00", "00", "04",\
	"00", "00", "00", "31", "2f", "31", "54", "52", "43", "4b", "00", "00", "00", "02", "00", "00",\
	"00", "38", "50", "52", "49", "56", "00", "00", "00", "27", "00", "00", "57", "4d", "2f", "4d",\
	"65", "64", "69", "61", "43", "6c", "61", "73", "73", "50", "72", "69", "6d", "61", "72", "79",\
	"49", "44", "00", "bc", "7d", "60", "d1", "23", "e3", "e2", "4b", "86", "a1", "48", "a4", "2a",\
	"28", "44", "1e", "50", "52", "49", "56", "00", "00", "00", "29", "00", "00", "57", "4d", "2f",\
	"4d", "65", "64", "69", "61", "43", "6c", "61", "73", "73", "53", "65", "63", "6f", "6e", "64",\
	"61", "72", "79", "49", "44", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "50", "52", "49", "56", "00", "00", "00", "1f", "00", "00",\
	"57", "4d", "2f", "57", "4d", "43", "6f", "6e", "74", "65", "6e", "74", "49", "44", "00", "37",\
	"c4", "20", "52", "78", "6b", "bc", "48", "89", "fc", "be", "10", "ea", "7f", "f6", "a2", "50",\
	"52", "49", "56", "00", "00", "00", "8a", "00", "00", "57", "4d", "2f", "55", "6e", "69", "71",\
	"75", "65", "46", "69", "6c", "65", "49", "64", "65", "6e", "74", "69", "66", "69", "65", "72",\
	"00", "41", "00", "4d", "00", "47", "00", "61", "00", "5f", "00", "69", "00", "64", "00", "3d",\
	"00", "52", "00", "20", "00", "20", "00", "31", "00", "30", "00", "38", "00", "34", "00", "30",\
	"00", "32", "00", "35", "00", "3b", "00", "41", "00", "4d", "00", "47", "00", "70", "00", "5f",\
	"00", "69", "00", "64", "00", "3d", "00", "50", "00", "20", "00", "20", "00", "20", "00", "34",\
	"00", "35", "00", "39", "00", "31", "00", "34", "00", "30", "00", "3b", "00", "41", "00", "4d",\
	"00", "47", "00", "74", "00", "5f", "00", "69", "00", "64", "00", "3d", "00", "54", "00", "20",\
	"00", "31", "00", "31", "00", "39", "00", "35", "00", "32", "00", "30", "00", "35", "00", "32",\
	"00", "00", "00", "50", "52", "49", "56", "00", "00", "00", "22", "00", "00", "57", "4d", "2f",\
	"57", "4d", "43", "6f", "6c", "6c", "65", "63", "74", "69", "6f", "6e", "49", "44", "00", "c5",\
	"67", "35", "f0", "b8", "f1", "59", "4d", "b4", "9e", "14", "c3", "4e", "6e", "28", "e5", "50",\
	"52", "49", "56", "00", "00", "00", "27", "00", "00", "57", "4d", "2f", "57", "4d", "43", "6f",\
	"6c", "6c", "65", "63", "74", "69", "6f", "6e", "47", "72", "6f", "75", "70", "49", "44", "00",\
	"c5", "67", "35", "f0", "b8", "f1", "59", "4d", "b4", "9e", "14", "c3", "4e", "6e", "28", "e5",\
	"50", "52", "49", "56", "00", "00", "00", "14", "00", "00", "57", "4d", "2f", "50", "72", "6f",\
	"76", "69", "64", "65", "72", "00", "41", "00", "4d", "00", "47", "00", "00", "00", "54", "43",\
	"4f", "4d", "00", "00", "00", "09", "00", "00", "00", "4f", "73", "75", "6e", "6c", "61", "64",\
	"65", "54", "50", "45", "31", "00", "00", "00", "09", "00", "00", "00", "4f", "73", "75", "6e",\
	"6c", "61", "64", "65", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "ff", "fb", "90", "64", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	"00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00",\
	]

	# Initialize the factory
	id3Factory = undefined
	beforeEach inject ($injector) ->
		id3Factory = $injector.get "ID3"

	it "checks if an hex strings starts with an ID3v1 tag", ->
		isID3v1 = id3Factory.isID3v1
		expect(isID3v1(id3v1)).toBe true
		expect(isID3v1(id3v2)).toBe false

	it "checks if an hex strings starts with an ID3v2 tag", ->
		isID3v2 = id3Factory.isID3v2
		expect(isID3v2(id3v1)).toBe false
		expect(isID3v2(id3v2)).toBe true

	it "retrieves title, artist, album from an id3v1 tag", ->
		fileInfo = {}
		id3Factory.addID3v1 id3v1, fileInfo
		expect(fileInfo.title).toBe "cassis"
		expect(fileInfo.artist).toBe "standup75"
		expect(fileInfo.album).toBeUndefined()

	it "retrives information form id3 v2 tag", ->
		deferred = {
			resolve: (->)
		}
		spyOn deferred, 'resolve'
		fileInfo = {}
		id3Factory.getAndAddID3v2 id3v2, fileInfo, null, deferred
		expect(deferred.resolve).toHaveBeenCalled()
		expect(fileInfo.title).toBe "139th Street"
		expect(fileInfo.artist).toBe "Osunlade"
		expect(fileInfo.album).toBe "Elements Beyond"

